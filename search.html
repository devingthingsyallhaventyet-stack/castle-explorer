<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search ‚Äî castlecore</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--stone:#d4c5a9;--cream:#f0ebe0;--candlelight:#c9a84c;--burgundy:#8b2335;--forest:#2d5a3d;--ivy:#3d5a3e;--shadow:#2a2522;--twilight:#4a5568;--hearth:#6b4c3b;--border:#e8e8e8;--radius:12px;--pill:20px;--warm-white:#faf8f4}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;color:var(--shadow);line-height:1.6;-webkit-font-smoothing:antialiased;background:var(--warm-white)}
h1,h2,h3,h4{font-family:'Playfair Display',serif;font-weight:400}
a{text-decoration:none;color:inherit}
img{max-width:100%;display:block}

/* NAV */
.nav{position:fixed;top:0;left:0;right:0;z-index:1000;background:#fff;border-bottom:1px solid var(--border);height:64px;display:flex;align-items:center;padding:0 24px}
.nav-inner{max-width:1280px;margin:0 auto;width:100%;display:flex;align-items:center;justify-content:space-between}
.nav-logo{font-family:'Playfair Display',serif;font-size:1.3rem;display:flex;align-items:center;gap:8px}
.nav-links{display:flex;gap:24px;align-items:center}
.nav-links a{font-size:.9rem;font-weight:500;color:var(--twilight);transition:color .2s}
.nav-links a:hover{color:var(--ivy)}
.nav-links .btn-explore{background:var(--burgundy);color:#fff;padding:8px 18px;border-radius:var(--pill);font-weight:600}
.nav-links .btn-explore:hover{background:#6e1a2a}
.hamburger{display:none;background:none;border:none;font-size:1.5rem;cursor:pointer}
.mobile-menu{display:none;position:fixed;top:64px;left:0;right:0;background:#fff;border-bottom:1px solid var(--border);padding:16px 24px;flex-direction:column;gap:16px;z-index:999}
.mobile-menu.open{display:flex}
.mobile-menu a{font-size:1rem;font-weight:500;color:var(--twilight);padding:8px 0}
@media(max-width:768px){.nav-links{display:none}.hamburger{display:block}}

/* SEARCH HEADER */
.search-header{margin-top:64px;padding:40px 24px 24px;background:var(--cream);border-bottom:1px solid var(--border)}
.search-header-inner{max-width:1280px;margin:0 auto}
.search-header h1{font-size:clamp(1.4rem,3vw,2rem);margin-bottom:8px}
.search-header .result-count{color:var(--twilight);font-size:.95rem;margin-bottom:16px}
.search-bar-wrap{position:relative;max-width:560px;margin-bottom:16px}
.search-bar-wrap input{width:100%;padding:12px 16px 12px 42px;border:1px solid var(--border);border-radius:var(--pill);font-size:.95rem;font-family:'Inter',sans-serif;outline:none;background:#fff}
.search-bar-wrap input:focus{border-color:var(--candlelight);box-shadow:0 0 0 3px rgba(201,168,76,.15)}
.search-bar-wrap .si{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:1.1rem;pointer-events:none}

/* FILTERS */
.filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.filter-label{font-size:.85rem;font-weight:600;color:var(--twilight);margin-right:4px}
.filter-btn{background:#fff;border:1px solid var(--border);padding:6px 14px;border-radius:var(--pill);font-size:.82rem;font-weight:500;cursor:pointer;transition:all .2s;font-family:'Inter',sans-serif;color:var(--shadow)}
.filter-btn:hover{border-color:var(--candlelight);background:rgba(201,168,76,.08)}
.filter-btn.active{background:var(--burgundy);color:#fff;border-color:var(--burgundy)}
.filter-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
select.filter-select{background:#fff;border:1px solid var(--border);padding:6px 12px;border-radius:var(--pill);font-size:.82rem;font-family:'Inter',sans-serif;color:var(--shadow);cursor:pointer;outline:none}

/* RESULTS GRID */
.results-section{padding:32px 24px 64px}
.results-inner{max-width:1280px;margin:0 auto}
.results-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px}
@media(max-width:900px){.results-grid{grid-template-columns:repeat(2,1fr);gap:16px}}
@media(max-width:540px){.results-grid{grid-template-columns:1fr}}

.card{border-radius:16px;overflow:hidden;background:#fff;border:1px solid var(--border);transition:transform .25s,box-shadow .25s;box-shadow:0 2px 12px rgba(120,90,50,.06);position:relative}
.card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(120,90,50,.12)}
.card::before,.card::after{content:'';position:absolute;width:24px;height:24px;border-color:var(--candlelight);border-style:solid;opacity:.15;z-index:2;pointer-events:none}
.card::before{top:8px;left:8px;border-width:2px 0 0 2px;border-radius:4px 0 0 0}
.card::after{bottom:8px;right:8px;border-width:0 2px 2px 0;border-radius:0 0 4px 0}
.card-img{height:190px;overflow:hidden;background:linear-gradient(135deg,var(--hearth),var(--forest))}
.card-img img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
.card:hover .card-img img{transform:scale(1.05)}
.card-body{padding:16px 18px 18px}
.card-body h3{font-size:1.1rem;margin-bottom:4px}
.card-loc{color:var(--twilight);font-size:.84rem;margin-bottom:6px}
.card-rating{color:var(--candlelight);font-size:.84rem;margin-bottom:6px}
.card-meta{display:flex;gap:6px;flex-wrap:wrap}
.type-pill{display:inline-block;background:var(--cream);color:var(--ivy);font-size:.72rem;font-weight:600;padding:3px 10px;border-radius:var(--pill);text-transform:capitalize}
.access-pill{display:inline-block;font-size:.72rem;font-weight:600;padding:3px 10px;border-radius:var(--pill)}
.access-free{background:#e8f5e9;color:#2e7d32}
.access-paid{background:#fff3e0;color:#e65100}

/* LOAD MORE */
.load-more-wrap{text-align:center;margin-top:40px}
.btn-load{display:inline-block;background:var(--burgundy);color:#fff;padding:12px 32px;border-radius:var(--pill);font-size:.95rem;font-weight:600;cursor:pointer;border:none;font-family:'Inter',sans-serif;transition:background .2s}
.btn-load:hover{background:#6e1a2a}

/* EMPTY */
.empty-state{text-align:center;padding:80px 24px;color:var(--twilight)}
.empty-state .empty-icon{font-size:3rem;margin-bottom:16px}
.empty-state h2{margin-bottom:8px;color:var(--shadow)}
.empty-state p{max-width:400px;margin:0 auto}

/* FOOTER */
footer{background:var(--shadow);color:#fff;padding:40px 24px 24px}
.footer-inner{max-width:1280px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;font-size:.8rem;color:rgba(255,255,255,.4)}
</style>
</head>
<body>

<nav class="nav">
<div class="nav-inner">
<a href="index.html" class="nav-logo">castlecore</a>
<div class="nav-links">
<a href="explore.html" class="btn-explore">Explore Map</a>
<a href="explore.html">Collections</a>
<a href="explore.html">Regions</a>
<a href="explore.html">Trails</a>
</div>
<button class="hamburger" onclick="document.querySelector('.mobile-menu').classList.toggle('open')" aria-label="Menu">‚ò∞</button>
</div>
</nav>
<div class="mobile-menu">
<a href="explore.html">üó∫Ô∏è Explore Map</a>
<a href="index.html">Home</a>
<a href="explore.html">Collections</a>
<a href="explore.html">Regions</a>
</div>

<div class="search-header">
<div class="search-header-inner">
<div class="search-bar-wrap">
<span class="si">üîç</span>
<input type="text" id="searchInput" placeholder="Search by name, postal code, or region..." autocomplete="off">
</div>
<h1 id="resultsTitle">Searching...</h1>
<p class="result-count" id="resultCount"></p>
<div class="filters" id="filters">
<span class="filter-label">Type:</span>
<button class="filter-btn active" data-type="all">All</button>
<span class="filter-sep"></span>
<span class="filter-label">Sort:</span>
<select class="filter-select" id="sortSelect">
<option value="relevance">Relevance</option>
<option value="rating">Highest Rated</option>
<option value="name">Name A-Z</option>
</select>
</div>
</div>
</div>

<div class="results-section">
<div class="results-inner">
<div class="results-grid" id="resultsGrid"></div>
<div class="empty-state" id="emptyState" style="display:none">
<div class="empty-icon">üè∞</div>
<h2>No sites found</h2>
<p>Try a different search term, or browse by region or type from the homepage.</p>
</div>
<div class="load-more-wrap" id="loadMoreWrap" style="display:none">
<button class="btn-load" id="loadMoreBtn">Load More</button>
</div>
</div>
</div>

<footer>
<div class="footer-inner">
<span>Built with ‚ù§Ô∏è for history lovers</span>
<span>¬© 2026 castlecore</span>
</div>
</footer>

<script src="data.js"></script>
<script>
(function(){
const PAGE_SIZE=24;
let allResults=[];
let filtered=[];
let shown=0;
let activeType='all';
let activeCountry='all';

function slug(n){return n.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')}

// Postal prefix to county mapping
const POSTAL_MAP={
'AB':'Aberdeenshire','AL':'Hertfordshire','B':'West Midlands','BA':'Somerset','BB':'Lancashire',
'BD':'West Yorkshire','BH':'Dorset','BL':'Greater Manchester','BN':'East Sussex','BR':'London',
'BS':'Bristol','BT':'Northern Ireland','CA':'Cumbria','CB':'Cambridgeshire','CF':'Cardiff',
'CH':'Cheshire','CM':'Essex','CO':'Essex','CR':'London','CT':'Kent','CV':'West Midlands',
'CW':'Cheshire','DA':'Kent','DD':'Angus','DE':'Derbyshire','DG':'Dumfries and Galloway',
'DH':'County Durham','DL':'County Durham','DN':'South Yorkshire','DT':'Dorset','DY':'West Midlands',
'E':'London','EC':'London','EH':'Edinburgh','EN':'Hertfordshire','EX':'Devon','FK':'Stirling',
'FY':'Lancashire','G':'Glasgow','GL':'Gloucestershire','GU':'Surrey','HA':'London',
'HD':'West Yorkshire','HG':'North Yorkshire','HP':'Buckinghamshire','HR':'Herefordshire',
'HS':'Western Isles','HU':'East Yorkshire','HX':'West Yorkshire','IG':'London','IP':'Suffolk',
'IV':'Highland','KA':'Ayrshire','KT':'Surrey','KW':'Highland','KY':'Fife',
'L':'Merseyside','LA':'Lancashire','LD':'Powys','LE':'Leicestershire','LL':'Gwynedd',
'LN':'Lincolnshire','LS':'West Yorkshire','LU':'Bedfordshire','M':'Greater Manchester',
'ME':'Kent','MK':'Buckinghamshire','ML':'Lanarkshire','N':'London','NE':'Tyne and Wear',
'NG':'Nottinghamshire','NN':'Northamptonshire','NP':'Newport','NR':'Norfolk','NW':'London',
'OL':'Greater Manchester','OX':'Oxfordshire','PA':'Renfrewshire','PE':'Cambridgeshire',
'PH':'Perth and Kinross','PL':'Devon','PO':'Hampshire','PR':'Lancashire','RG':'Berkshire',
'RH':'West Sussex','RM':'London','S':'South Yorkshire','SA':'Swansea','SE':'London',
'SG':'Hertfordshire','SK':'Cheshire','SL':'Berkshire','SM':'London','SN':'Wiltshire',
'SO':'Hampshire','SP':'Wiltshire','SR':'Tyne and Wear','SS':'Essex','ST':'Staffordshire',
'SW':'London','SY':'Shropshire','TA':'Somerset','TD':'Scottish Borders','TF':'Shropshire',
'TN':'Kent','TQ':'Devon','TR':'Cornwall','TS':'North Yorkshire','TW':'London',
'UB':'London','W':'London','WA':'Cheshire','WC':'London','WD':'Hertfordshire',
'WF':'West Yorkshire','WN':'Greater Manchester','WR':'Worcestershire','WS':'West Midlands',
'WV':'West Midlands','YO':'North Yorkshire','ZE':'Shetland'
};

function resolvePostal(q){
const upper=q.toUpperCase().replace(/\s/g,'');
// Try 2-letter then 1-letter prefix
const p2=upper.substring(0,2);
const p1=upper.substring(0,1);
if(/^[A-Z]{1,2}\d/.test(upper)){
return POSTAL_MAP[p2]||POSTAL_MAP[p1]||null;
}
return null;
}

function getParams(){
const p=new URLSearchParams(window.location.search);
return {q:p.get('q'),region:p.get('region'),type:p.get('type'),tag:p.get('tag')};
}

function findResults(params){
if(typeof CASTLES==='undefined')return[];
let results=[];
let title='';

if(params.region){
const r=params.region.toLowerCase();
results=CASTLES.filter(c=>(c.county&&c.county.toLowerCase()===r)||(c.country&&c.country.toLowerCase()===r));
title=params.region;
}else if(params.type){
const t=params.type.toLowerCase();
results=CASTLES.filter(c=>c.type&&c.type.toLowerCase().includes(t));
title=params.type.charAt(0).toUpperCase()+params.type.slice(1)+'s';
}else if(params.tag){
const t=params.tag.toLowerCase();
if(t==='free'){
results=CASTLES.filter(c=>c.access==='free'||(c.tags&&c.tags.includes('free')));
title='Free to Visit';
}else{
results=CASTLES.filter(c=>c.tags&&c.tags.some(tag=>tag.toLowerCase().includes(t)));
title=params.tag.charAt(0).toUpperCase()+params.tag.slice(1);
}
}else if(params.q){
const q=params.q.trim();
// Check exact match -> redirect
const exact=CASTLES.find(c=>c.name.toLowerCase()===q.toLowerCase());
if(exact){window.location.replace('site/'+slug(exact.name)+'.html');return[];}

// Check postal code
const postalCounty=resolvePostal(q);
if(postalCounty){
results=CASTLES.filter(c=>c.county&&c.county.toLowerCase()===postalCounty.toLowerCase());
title=postalCounty+' (from postal code)';
}else{
const lq=q.toLowerCase();
// Search name, county, country
results=CASTLES.filter(c=>
c.name.toLowerCase().includes(lq)||
(c.county&&c.county.toLowerCase().includes(lq))||
(c.country&&c.country.toLowerCase().includes(lq))||
(c.type&&c.type.toLowerCase().includes(lq))
);
title=q;
}
}

return {results,title};
}

function stars(r){
if(!r)return '';
const full=Math.floor(r);
const half=r-full>=0.3;
let s='';
for(let i=0;i<full;i++)s+='‚òÖ';
if(half)s+='¬Ω';
return s+' '+r.toFixed(1);
}

function renderCard(c){
const imgHtml=c.wiki_img||c.image
?`<img src="${c.wiki_img||c.image}" alt="${c.name}" loading="lazy" onerror="this.style.display='none'">`
:'';
const ratingHtml=c.rating?`<p class="card-rating">${stars(c.rating)}</p>`:'';
const accessHtml=c.access?`<span class="access-pill ${c.access==='free'?'access-free':'access-paid'}">${c.access}</span>`:'';
return `<a class="card" href="site/${slug(c.name)}.html">
<div class="card-img">${imgHtml}</div>
<div class="card-body">
<h3>${c.name}</h3>
<p class="card-loc">${[c.county,c.country].filter(Boolean).join(', ')}</p>
${ratingHtml}
<div class="card-meta"><span class="type-pill">${c.type||'site'}</span>${accessHtml}</div>
</div></a>`;
}

function getTypeFilters(results){
const types={};
results.forEach(c=>{if(c.type)types[c.type]=(types[c.type]||0)+1});
return Object.entries(types).sort((a,b)=>b[1]-a[1]);
}

function getCountryFilters(results){
const countries={};
results.forEach(c=>{if(c.country)countries[c.country]=(countries[c.country]||0)+1});
return Object.entries(countries).sort((a,b)=>b[1]-a[1]);
}

function applyFilters(){
filtered=allResults;
if(activeType!=='all')filtered=filtered.filter(c=>c.type===activeType);
if(activeCountry!=='all')filtered=filtered.filter(c=>c.country===activeCountry);
const sort=document.getElementById('sortSelect').value;
if(sort==='rating')filtered.sort((a,b)=>(b.rating||0)-(a.rating||0));
else if(sort==='name')filtered.sort((a,b)=>a.name.localeCompare(b.name));
shown=0;
renderPage();
}

function renderPage(){
const grid=document.getElementById('resultsGrid');
const empty=document.getElementById('emptyState');
const loadWrap=document.getElementById('loadMoreWrap');
const countEl=document.getElementById('resultCount');

if(!filtered.length){
grid.innerHTML='';
empty.style.display='block';
loadWrap.style.display='none';
countEl.textContent='0 results';
return;
}
empty.style.display='none';
const end=Math.min(shown+PAGE_SIZE,filtered.length);
const chunk=filtered.slice(shown,end);
if(shown===0)grid.innerHTML='';
grid.innerHTML+=chunk.map(renderCard).join('');
shown=end;
countEl.textContent=filtered.length+' result'+(filtered.length!==1?'s':'');
loadWrap.style.display=shown<filtered.length?'block':'none';
}

function buildTypeButtons(results){
const types=getTypeFilters(results);
const countries=getCountryFilters(results);
const container=document.getElementById('filters');
let html='<span class="filter-label">Type:</span>';
html+='<button class="filter-btn active" data-type="all">All</button>';
types.slice(0,6).forEach(([t,n])=>{
html+=`<button class="filter-btn" data-type="${t}">${t.charAt(0).toUpperCase()+t.slice(1)} (${n})</button>`;
});
if(countries.length>1){
html+='<span class="filter-sep"></span><span class="filter-label">Country:</span>';
html+='<button class="filter-btn active" data-country="all">All</button>';
countries.forEach(([c,n])=>{
html+=`<button class="filter-btn" data-country="${c}">${c} (${n})</button>`;
});
}
html+='<span class="filter-sep"></span><span class="filter-label">Sort:</span>';
html+='<select class="filter-select" id="sortSelect"><option value="relevance">Relevance</option><option value="rating">Highest Rated</option><option value="name">Name A-Z</option></select>';
container.innerHTML=html;

container.querySelectorAll('[data-type]').forEach(btn=>{
btn.addEventListener('click',()=>{
container.querySelectorAll('[data-type]').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
activeType=btn.dataset.type;
applyFilters();
});
});
container.querySelectorAll('[data-country]').forEach(btn=>{
btn.addEventListener('click',()=>{
container.querySelectorAll('[data-country]').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
activeCountry=btn.dataset.country;
applyFilters();
});
});
document.getElementById('sortSelect').addEventListener('change',applyFilters);
}

function init(){
const params=getParams();
const {results,title}=findResults(params);
allResults=results;
filtered=results;
const titleEl=document.getElementById('resultsTitle');
if(title)titleEl.textContent='Results for "'+title+'"';
else titleEl.textContent='Search';
document.title=title?title+' ‚Äî castlecore':'Search ‚Äî castlecore';

const input=document.getElementById('searchInput');
input.value=params.q||params.region||params.type||params.tag||'';
input.addEventListener('keydown',e=>{
if(e.key==='Enter'){
const q=input.value.trim();
if(q)window.location.href='search.html?q='+encodeURIComponent(q);
}
});

buildTypeButtons(results);
renderPage();
document.getElementById('loadMoreBtn').addEventListener('click',renderPage);
}

if(typeof CASTLES!=='undefined')init();
else window.addEventListener('load',init);
})();
</script>
</body>
</html>
